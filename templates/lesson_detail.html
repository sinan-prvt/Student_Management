{% extends "base.html" %}
{% load embed_content %}

{% block title %}{{ lesson.title }} | {{ lesson.course.title }}{% endblock %}

{% block content %}
<div class="container my-5">

    <!-- Lesson Header -->
    <div class="mb-4">
        <h2 class="fw-bold">{{ lesson.title }}</h2>
        <p class="text-muted">Part of: <strong>{{ lesson.course.title }}</strong></p>
    </div>

    <!-- Tabs for Video / PDF -->
    {% if lesson.video_url or lesson.file %}
    <ul class="nav nav-tabs mb-3" id="lessonTab" role="tablist">
        {% if lesson.video_url %}
            <li class="nav-item">
                <a class="nav-link active" id="video-tab" data-bs-toggle="tab" href="#video" role="tab">
                    ðŸŽ¬ Video
                </a>
            </li>
        {% endif %}
        {% if lesson.file %}
            <li class="nav-item">
                <a class="nav-link {% if not lesson.video_url %}active{% endif %}" id="pdf-tab" data-bs-toggle="tab" href="#pdf" role="tab">
                    ðŸ“„ PDF
                </a>
            </li>
        {% endif %}
    </ul>

    <div class="tab-content">
        {% if lesson.video_url %}
        <div class="tab-pane fade show active" id="video" role="tabpanel">
            <div class="mb-3">
                <!-- YouTube embed -->
                <div class="ratio ratio-16x9 shadow-sm rounded">
                    <iframe width="800" height="450"
                            src="{{ lesson.video_url|youtube_embed }}"
                            title="Lesson Video"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                    </iframe>
                </div>

                <!-- Fallback link -->
                <p class="mt-2 text-center">
                    <a href="{{ lesson.video_url }}" target="_blank" class="btn btn-outline-danger btn-sm">
                        â–¶ Watch on YouTube
                    </a>
                </p>
            </div>
        </div>
        {% endif %}

        {% if lesson.file %}
        <div class="tab-pane fade {% if not lesson.video_url %}show active{% endif %}" id="pdf" role="tabpanel">
            <div class="mb-3">
                {% embed_pdf lesson.file.url 800 600 %}
            </div>
            <a href="{{ lesson.file.url }}" target="_blank" class="btn btn-outline-info btn-sm">
                ðŸ“¥ Open PDF Externally
            </a>
        </div>
        {% endif %}
    </div>
    {% else %}
        <p class="text-muted">No content available for this lesson.</p>
    {% endif %}

    <!-- Lesson Completion -->
    <div class="mt-4">
        {% if lesson in completed_lessons %}
            <div class="alert alert-success d-flex align-items-center" role="alert">
                âœ… You have completed this lesson.
            </div>
        {% else %}
            <form action="{% url 'complete_lesson' course_id=lesson.course.id lesson_id=lesson.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-primary">
                    Mark as Completed
                </button>
            </form>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-4">
        <a href="{% url 'course_detail' lesson.course.id %}" class="btn btn-outline-secondary">
            â¬… Back to Course Lessons
        </a>
    </div>

</div>
{% endblock %}
